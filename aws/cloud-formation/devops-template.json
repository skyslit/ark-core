{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "mProjectName": {
      "Type": "String",
      "Description": "e.g. small-project"
    },
    "mVPCID": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "Please choose the target VPC"
    },
    "mSubnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "Please choose preferred subnets"
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Designer": {
      "bac3d5f5-6f51-4f17-845a-9a924f6b4303": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 180
        },
        "z": 1,
        "embeds": []
      },
      "dbdf8573-365d-4db7-83d5-b6b74e153de2": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 120,
          "y": 0
        },
        "z": 1,
        "embeds": []
      },
      "439e00c8-098f-4560-9d80-85c1934a5d5a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 90
        },
        "z": 1,
        "embeds": []
      },
      "963407ab-5a04-46d3-92db-c31e3fc6533f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 240,
          "y": 120
        },
        "z": 1,
        "embeds": [],
        "dependson": ["3f53ec46-08db-4fa8-90ff-91c2bf64a7ef"]
      },
      "77040f03-aa43-4243-b0b2-2bc5d41705f1": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 240,
          "y": 0
        },
        "z": 1,
        "embeds": []
      },
      "6a80220f-ef52-4539-a876-8192cec0556f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 360,
          "y": 0
        },
        "z": 1,
        "embeds": []
      },
      "8e4f9f47-bff9-45ec-80fe-df0060491383": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 450,
          "y": 210
        },
        "z": 1,
        "embeds": []
      },
      "3f53ec46-08db-4fa8-90ff-91c2bf64a7ef": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 450,
          "y": 90
        },
        "z": 1,
        "embeds": []
      },
      "76130ef7-94cd-4ef7-843e-48fe4c0277b0": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 570,
          "y": 90
        },
        "z": 1,
        "embeds": []
      },
      "02f17461-eeec-4b55-8a74-26fc88a7d2df": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 690,
          "y": 90
        },
        "z": 1,
        "embeds": []
      },
      "b37559ba-66e4-4d93-974e-690ca3ab547f": {
        "source": {
          "id": "963407ab-5a04-46d3-92db-c31e3fc6533f"
        },
        "target": {
          "id": "3f53ec46-08db-4fa8-90ff-91c2bf64a7ef"
        },
        "z": 11
      }
    }
  },
  "Resources": {
    "codeCommit": {
      "Type": "AWS::CodeCommit::Repository",
      "Properties": {
        "RepositoryDescription": "A sample description",
        "RepositoryName": {
          "Fn::Sub": [
            "${ProjectNameStr}-code-repo",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        },
        "Tags": [],
        "Triggers": []
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "bac3d5f5-6f51-4f17-845a-9a924f6b4303"
        }
      }
    },
    "imageRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": {
          "Fn::Sub": [
            "${ProjectNameStr}-image",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "439e00c8-098f-4560-9d80-85c1934a5d5a"
        }
      }
    },
    "taskDef": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            "Image": "nginx:latest",
            "MountPoints": [],
            "Name": {
              "Fn::Sub": [
                "${ProjectNameStr}-container",
                {
                  "ProjectNameStr": {
                    "Ref": "mProjectName"
                  }
                }
              ]
            },
            "PortMappings": [
              {
                "ContainerPort": 80,
                "HostPort": 80
              }
            ],
            "Privileged": false
          }
        ],
        "Cpu": "256",
        "Family": {
          "Fn::Sub": [
            "${ProjectNameStr}-task-def",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        },
        "Memory": "512",
        "NetworkMode": "awsvpc"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "77040f03-aa43-4243-b0b2-2bc5d41705f1"
        }
      }
    },
    "ecsCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Fn::Sub": [
            "${ProjectNameStr}-ecs-cluster",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "dbdf8573-365d-4db7-83d5-b6b74e153de2"
        }
      }
    },
    "loadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "IpAddressType": "ipv4",
        "Name": {
          "Fn::Sub": [
            "${ProjectNameStr}-load-balancer",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        },
        "Scheme": "internet-facing",
        "Subnets": {
          "Ref": "mSubnets"
        },
        "Type": "application"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "3f53ec46-08db-4fa8-90ff-91c2bf64a7ef"
        }
      }
    },
    "httpListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "Port": 80,
        "Protocol": "HTTP",
        "LoadBalancerArn": {
          "Ref": "loadBalancer"
        },
        "DefaultActions": [
          {
            "Type": "fixed-response",
            "Order": 50000,
            "FixedResponseConfig": {
              "ContentType": "text/plain",
              "MessageBody": "NOT_FOUND",
              "StatusCode": 404
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "76130ef7-94cd-4ef7-843e-48fe4c0277b0"
        }
      }
    },
    "httpListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "Conditions": [
          {
            "Field": "path-pattern",
            "PathPatternConfig": {
              "Values": ["/**"]
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "Order": 1,
            "TargetGroupArn": {
              "Ref": "devTargetGroup"
            }
          }
        ],
        "ListenerArn": {
          "Ref": "httpListener"
        },
        "Priority": 1
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "02f17461-eeec-4b55-8a74-26fc88a7d2df"
        }
      }
    },
    "devTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Name": {
          "Fn::Sub": [
            "${ProjectNameStr}-dev-target-group",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        },
        "Port": 80,
        "Protocol": "HTTP",
        "TargetType": "ip",
        "VpcId": {
          "Ref": "mVPCID"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "8e4f9f47-bff9-45ec-80fe-df0060491383"
        }
      }
    },
    "devService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "LaunchType": "FARGATE",
        "Cluster": {
          "Ref": "ecsCluster"
        },
        "ServiceName": {
          "Fn::Sub": [
            "dev-${ProjectNameStr}-service",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        },
        "SchedulingStrategy": "REPLICA",
        "DesiredCount": 1,
        "DeploymentController": {
          "Type": "ECS"
        },
        "TaskDefinition": {
          "Ref": "taskDef"
        },
        "LoadBalancers": [
          {
            "ContainerName": {
              "Fn::Sub": [
                "${ProjectNameStr}-container",
                {
                  "ProjectNameStr": {
                    "Ref": "mProjectName"
                  }
                }
              ]
            },
            "ContainerPort": 80,
            "TargetGroupArn": {
              "Ref": "devTargetGroup"
            }
          }
        ],
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "SecurityGroups": [
              {
                "Fn::GetAtt": ["securityGroup", "GroupId"]
              }
            ],
            "Subnets": {
              "Ref": "mSubnets"
            }
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "963407ab-5a04-46d3-92db-c31e3fc6533f"
        }
      },
      "DependsOn": ["loadBalancer", "httpListenerRule"]
    },
    "securityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": {
          "Fn::Sub": [
            "Security group for ${ProjectNameStr}",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        },
        "GroupName": {
          "Fn::Sub": [
            "${ProjectNameStr}-sg",
            {
              "ProjectNameStr": {
                "Ref": "mProjectName"
              }
            }
          ]
        },
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTP",
            "FromPort": 80,
            "IpProtocol": "tcp",
            "ToPort": 80
          }
        ],
        "VpcId": {
          "Ref": "mVPCID"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6a80220f-ef52-4539-a876-8192cec0556f"
        }
      }
    }
  },
  "Outputs": {
    "CloneURL": {
      "Description": "Information about the value",
      "Value": {
        "Fn::GetAtt": ["codeCommit", "CloneUrlHttp"]
      }
    }
  }
}
